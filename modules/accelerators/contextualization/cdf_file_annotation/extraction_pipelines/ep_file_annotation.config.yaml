externalId: {{ extractionPipelineExternalId }}
config:
  dataModelViews:
    coreAnnotationView:
      schemaSpace: cdf_cdm
      externalId: CogniteDiagramAnnotation
      version: v1
    annotationStateView:
      schemaSpace: {{ annotationStateSchemaSpace }}
      instanceSpace: {{fileInstanceSpace}}
      externalId: {{ annotationStateExternalId }}
      version: {{ annotationStateVersion }}
    fileView:
      schemaSpace: {{ fileSchemaSpace }}
      instanceSpace: {{fileInstanceSpace}}
      externalId: {{ fileExternalId }}
      version: {{ fileVersion }}
      annotationType: diagrams.FileLink
    targetEntitiesView:
      schemaSpace: {{ targetEntitySchemaSpace }}
      instanceSpace: {{targetEntityInstanceSpace}}
      externalId: {{ targetEntityExternalId }}
      version: {{ targetEntityVersion }}
      annotationType: diagrams.AssetLink
  prepareFunction:
    # getFilesForAnnotationResetQuery:
    #   targetView:
    #     schemaSpace: {{fileSchemaSpace}}
    #     externalId: {{fileExternalId}}
    #     version: {{fileVersion}}
    #   filters:
    #     - values: ["AnnotationFailed", "Annotated"]
    #       negate: False
    #       operator: In
    #       targetProperty: tags
    getFilesToAnnotateQuery:
      targetView:
        schemaSpace: {{ fileSchemaSpace }}
        externalId: {{ fileExternalId }}
        version: {{ fileVersion }}
      filters:
        - values: ["ToAnnotate"] # NOTE: Do not change unless there's a good reason
          negate: False
          operator: In
          targetProperty: tags
        - values: ["AnnotationInProcess", "Annotated", "AnnotationFailed"] # NOTE: Do not change unless there's a good reason
          negate: True
          operator: In
          targetProperty: tags
      limit: 10000
  launchFunction:
    batchSize: 50
    fileSearchProperty: aliases
    targetEntitiesSearchProperty: aliases
    primaryScopeProperty: None
    secondaryScopeProperty:
    patternMode: True
    fileResourceProperty:
    targetEntitiesResourceProperty:
    dataModelService:
      getFilesToProcessQuery:
        targetView:
          schemaSpace: {{ annotationStateSchemaSpace }}
          externalId: {{ annotationStateExternalId }}
          version: {{ annotationStateVersion }}
        filters:
          - values: ["New", "Retry"] # NOTE: Do not change unless there's a good reason
            negate: False
            operator: In
            targetProperty: annotationStatus
        limit: 1000
      getTargetEntitiesQuery:
        targetView:
          schemaSpace: {{ targetEntitySchemaSpace }}
          externalId: {{ targetEntityExternalId }}
          version: {{ targetEntityVersion }}
        filters:
          - values: ["DetectInDiagrams"] # NOTE: Do not change unless there's a good reason
            negate: False
            operator: In
            targetProperty: tags
      getFileEntitiesQuery:
        targetView:
          schemaSpace: {{ fileSchemaSpace }}
          externalId: {{ fileExternalId }}
          version: {{ fileVersion }}
        filters:
          - values: ["DetectInDiagrams"] # NOTE: Do not change unless there's a good reason
            negate: False
            operator: In
            targetProperty: tags
    cacheService:
      cacheTimeLimit: 24 # hours
      rawDb: {{ rawDb }}
      rawTableCache: {{ rawTableCache }}
      rawManualPatternsCatalog: {{ rawManualPatternsCatalog }}
    annotationService:
      pageRange: 50
      partialMatch: True
      diagramDetectConfig:
        connectionFlags:
          noTextInbetween: True
          naturalReadingOrder: True
        readEmbeddedText: True
  finalizeFunction:
    cleanOldAnnotations: True
    maxRetryAttempts: 3
    retrieveService:
      getJobIdQuery:
        targetView:
          schemaSpace: {{ annotationStateSchemaSpace }}
          externalId: {{ annotationStateExternalId }}
          version: {{ annotationStateVersion }}
        filters:
          - values: "Processing" # NOTE: Do not change unless there's a good reason
            negate: False
            operator: Equals
            targetProperty: annotationStatus
          - negate: False # # NOTE: Do not change unless there's a good reason
            operator: Exists
            targetProperty: diagramDetectJobId
    applyService:
      sinkNode:
          space: {{ patternModeInstanceSpace }}
          externalId: {{patternDetectSink}}
      autoApprovalThreshold: 1.0
      autoSuggestThreshold: 1.0
    reportService:
      rawDb: {{ rawDb }}
      rawTableDocTag: {{ rawTableDocTag }}
      rawTableDocDoc: {{ rawTableDocDoc }}
      rawTableDocPattern: {{ rawTableDocPattern }}
      rawBatchSize: 1000
