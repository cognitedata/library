name: Release Packages

on:
  push:
    branches: 
    - hardening
  pull_request:
    types: [closed]
    branches:
    - main

jobs:
  release:
    if: github.event_name != 'pull_request' || (github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main')
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Needed to get full git history for short hash
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Create packages.zip
      run: |
        python release_packages.py
        
    - name: Calculate SHA256 checksum
      id: checksum
      run: |
        SHA256=$(sha256sum packages.zip | cut -d' ' -f1)
        echo "checksum=sha256:$SHA256" >> $GITHUB_OUTPUT
        
    - name: Get timestamp and short hash
      id: version
      run: |
        # Get current date in YYYYMMDD format
        TIMESTAMP=$(date +%Y%m%d)
        # Get current date and time for latest release
        CURRENT_DATETIME=$(date '+%Y-%m-%d %H:%M:%S UTC')
        # Get short hash (7 characters)
        SHORT_HASH=$(git rev-parse --short HEAD)
        # Create version string
        VERSION="${TIMESTAMP}-${SHORT_HASH}"
        echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
        echo "short_hash=$SHORT_HASH" >> $GITHUB_OUTPUT
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "current_datetime=$CURRENT_DATETIME" >> $GITHUB_OUTPUT
        echo "version=$VERSION" >> $GITHUB_ENV
        
    - name: Create timestamped release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: Release ${{ steps.version.outputs.version }}
        body: |
          **Released:** ${{ steps.version.outputs.current_datetime }}
          
          **Usage:** 
          ```
          cdf.toml:
          [library.deployment_packs]
          url = "https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/packages.zip"
          checksum = "${{ steps.checksum.outputs.checksum }}"
          ```
        files: packages.zip
        draft: false
        prerelease: false
        
    - name: Update latest release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: latest
        name: Latest
        body: |
          
          **Released:** ${{ steps.version.outputs.current_datetime }}
          
          **Usage:** 
          ```
          cdf.toml:
          [library.deployment_packs]
          url = https://github.com/${{ github.repository }}/releases/download/latest/packages.zip
          checksum = ${{ steps.checksum.outputs.checksum }}
          ```
          
        files: packages.zip
        draft: false
        prerelease: false
        update_existing: true
